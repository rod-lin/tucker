module Test.Enc where

import qualified Data.ByteString as BSR

import Test.Util
import Test.HUnit
import Test.Common

hash256Test = TestCase $ do
    let h1 = read "00000000000404cb000000000000000000000000000000000000000000000000"
        h2 = read "00000000008004cb000000000000000000000000000000000000000000000000"
        h3 = read "7f00000000000000000000000000000000000000000000000000000000000000"
        h4 = read "0000000000000000000000000000000000000000000000000000000000000000"

        h5 = read "000000000000000000000000000000000000000000000000000000000000aabb"
        h6 = read "00000000000000000000000000000000000000000000000000000000000000aa"

        h7 = read "ff00000000000000000000000000000000000000000000000000000000000000"

    assertBool "wrong compare result 1" $ h2 > h1
    assertBool "wrong compare result 2" $ h3 > h2
    assertBool "wrong compare result 3" $ h7 > h3 -- hash256 is unsigned
    assertBool "wrong compare result 4" $ h5 > h6
    assertBool "wrong compare result 5" $ h6 > h4

    assertEqual "wrong encode result 1" 0x1b0404cb (packHash256 h1)
    assertEqual "wrong encode result 2" 0x1c008004 (packHash256 h2)

    assertEqual "wrong decode result 1" h1 (unpackHash256 0x1b0404cb)
    assertEqual "should overflow 3" h3 (unpackHash256 0x2200007f)
    assertEqual "should overflow 4" h4 (unpackHash256 0x237fffff)

    assertEqual "wrong decode result 5" h5 (unpackHash256 0x0300aabb)
    assertEqual "wrong decode result 6" h6 (unpackHash256 0x0200aabb)

basicEncTest = TestCase $ do
    -- encodeVInt
    -- encodeInt

    forM_ encode_map_be $ \(num, vint_bs, vword_bs) -> do
        assertEqual ("wrong big-endian encoding as vint of " ++ show num)
            vint_bs (encodeVInt BigEndian num)

        assertEqual ("wrong little-endian encoding as vint of " ++ show num)
            (BSR.reverse vint_bs) (encodeVInt LittleEndian num)

        assertEqual ("wrong big-endian encoding as vword of " ++ show num)
            vword_bs (encodeVWord BigEndian num)

        assertEqual ("wrong little-endian encoding as vword of " ++ show num)
            (BSR.reverse vword_bs) (encodeVWord LittleEndian num)

basicDecTest = TestCase $ do
    return ()

sizeOfTest = TestCase $ do
    let blocks =
            [
                -- mainnet: block 1 to block 7
                "010000006fe28c0ab6f1b372c1a6a246ae63f74f931e8365e15a089c68d6190000000000982051fd1e4ba744bbbe680e1fee14677ba1a3c3540bf7b1cdb606e857233e0e61bc6649ffff001d01e362990101000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0704ffff001d0104ffffffff0100f2052a0100000043410496b538e853519c726a2c91e61ec11600ae1390813a627c66fb8be7947be63c52da7589379515d4e0a604f8141781e62294721166bf621e73a82cbf2342c858eeac00000000",
                "010000004860eb18bf1b1620e37e9490fc8a427514416fd75159ab86688e9a8300000000d5fdcc541e25de1c7a5addedf24858b8bb665c9f36ef744ee42c316022c90f9bb0bc6649ffff001d08d2bd610101000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0704ffff001d010bffffffff0100f2052a010000004341047211a824f55b505228e4c3d5194c1fcfaa15a456abdf37f9b9d97a4040afc073dee6c89064984f03385237d92167c13e236446b417ab79a0fcae412ae3316b77ac00000000",
                "01000000bddd99ccfda39da1b108ce1a5d70038d0a967bacb68b6b63065f626a0000000044f672226090d85db9a9f2fbfe5f0f9609b387af7be5b7fbb7a1767c831c9e995dbe6649ffff001d05e0ed6d0101000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0704ffff001d010effffffff0100f2052a0100000043410494b9d3e76c5b1629ecf97fff95d7a4bbdac87cc26099ada28066c6ff1eb9191223cd897194a08d0c2726c5747f1db49e8cf90e75dc3e3550ae9b30086f3cd5aaac00000000",
                "010000004944469562ae1c2c74d9a535e00b6f3e40ffbad4f2fda3895501b582000000007a06ea98cd40ba2e3288262b28638cec5337c1456aaf5eedc8e9e5a20f062bdf8cc16649ffff001d2bfee0a90101000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0704ffff001d011affffffff0100f2052a01000000434104184f32b212815c6e522e66686324030ff7e5bf08efb21f8b00614fb7690e19131dd31304c54f37baa40db231c918106bb9fd43373e37ae31a0befc6ecaefb867ac00000000",

                -- insert fork here

                "0100000085144a84488ea88d221c8bd6c059da090e88f8a2c99690ee55dbba4e00000000e11c48fecdd9e72510ca84f023370c9a38bf91ac5cae88019bee94d24528526344c36649ffff001d1d03e4770101000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0704ffff001d0120ffffffff0100f2052a0100000043410456579536d150fbce94ee62b47db2ca43af0a730a0467ba55c79e2a7ec9ce4ad297e35cdbb8e42a4643a60eef7c9abee2f5822f86b1da242d9c2301c431facfd8ac00000000",
                "01000000fc33f596f822a0a1951ffdbf2a897b095636ad871707bf5d3162729b00000000379dfb96a5ea8c81700ea4ac6b97ae9a9312b2d4301a29580e924ee6761a2520adc46649ffff001d189c4c970101000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0704ffff001d0123ffffffff0100f2052a0100000043410408ce279174b34c077c7b2043e3f3d45a588b85ef4ca466740f848ead7fb498f0a795c982552fdfa41616a7c0333a269d62108588e260fd5a48ac8e4dbf49e2bcac00000000",
                "010000008d778fdc15a2d3fb76b7122a3b5582bea4f21f5a0c693537e7a03130000000003f674005103b42f984169c7d008370967e91920a6a5d64fd51282f75bc73a68af1c66649ffff001d39a59c860101000000010000000000000000000000000000000000000000000000000000000000000000ffffffff0704ffff001d012bffffffff0100f2052a01000000434104a59e64c774923d003fae7491b2a7f75d6b7aa3f35606a8ff1cf06cd3317d16a41aa16928b1df1f631f31f28c7da35d4edad3603adb2338c4d4dd268f31530555ac00000000"
            ]

        txns =
            [
                "010000000132868d315b56eae8fc9175ee9b8faae2dbe8230909eaaeb7882c9840820db98c010000006b483045022100e3704294402a2e8d67c4fe9099c0efd9d07d5afdacb06170724c5ca5cb96931e02201d6ad1852baf6b51af815368fecd0307829b731754b3d1a6f2b735bd63e1d2b9012102b0041c89d03710ffc685b68c82aedfeb24edd9bfed55a74e4112084a5075a21bffffffff0300e1f5050000000017a914a6c2badadcf2eb342b9e63c0ac5267a8b2aa4e838780f0fa020000000017a9144dbcd1bb352e8d27d562ff4ea1fdb03dad6deb2987403decb7010000001976a9145fe77aa6ce0913f1c9facdc62b70412c0f50154588ac00000000",
                "0100000001fa6e93714314547dc1968d97b02978d5d10dea73d2cc254a44774c924a13e03401000000fd470100473044022034a6613804291dc5dae8aa4caf9ac4f266aa3f0634469f6a7bb3d62c2151261e02203151a060b95bd6e8896fd5fe4e155d8ee4b54ddea4fbb67033d45ffd548261c901493046022100bf6302cc7e871c2377e6802fe5a13d8018bc63a4eafa90da648d7dbb6db6e4b1022100a5583b9695b9f241ea457d0fc832b50d2c13e0fdb2dc30a7d35d0d9dc5a5902c0148304502200728fd420d8cffe58bb967036a8e55c87473575b14f170d862a73f3f41684ea2022100adfeea7b971963638defee9588f7fa02edbf89abb821a2c90350bb028b97f001014c69532103af88375d5fc9230446365b7d33540a73397ab3cc1a9f3e306a26833d1bfc260f21030677e0dd58025a5404747fbc64083040083acf3b390515f71a8ede95dc9c4d8a2103af88375d5fc9230446365b7d33540a73397ab3cc1a9f3e306a26833d1bfc260f53aeffffffff0170c9fa02000000001976a91430762a648dae2f279e7edb881883fa41502c249888ac00000000",
                "010000000109537c7f10c0faa6fa0c9e9108819cc5e907ecf633ed31cafe7f89d9e1028767000000006b483045022100fe4d9e39b5b71e8c8e3ba310b49019dd10b5d4fa91890b804834eddcd877866c02202e4d986516a5d7a96329146ac6725d28c868630eaeca309c81f34be08d7364f4012102210ba76412d0260fb6c753eb0b48056e7f415343e8a39175956dd69895a08b04ffffffff02e09304000000000017a91436d4387548818c6db0d52e6f83b69412ad5f1c4487cfa27201000000001976a9147c20c8b419a8cb49332c8cf44ebc23d0692f42b088ac00000000",
                "01000000011cbe9ea2377ac8e7975e389385b5d4955b08b103343487157411c511654b5d9f00000000ea483045022100d9073d0bb21de471a26cdad0b7027e1866a2d55e4d6ed33c9827be0a26a01ad40220742c45e6fae57ff26477d4b124cc42ea59c68dc3f3523a388cab8ece5e15cff6012103456df86e6d20dda8606562ffa7361a7d5434850bac66bf597720622810d335b2004c7c76a9145cb1c75c0764b6d6b5aef2a5d9dd0a27531d662487632103a5fa9d4d893439c5af8682b9c148927160f285f990b50bac34f64fb94decbde5ac67a91479bb203cfdc27e317528340a12380efbbf156e1c87632103ba61f817e24a076f515c8d2484eea4f32550186273b5fbea57ac7a64ba5257e2ac68676a68ffffffff01d06c0400000000001976a91490e343c0e6e18b1bb3c5fd98a2187808ede2893988ac00000000",
                "01000000010976d38c7c8a74e0e01fe7e72cf8a3302384c35a074cc5a12a8c8e69f66e02c700000000910047304402206524f73cb7227479566f3c5caadabfdf8d249a8b22fca73da27bae7e2595db1302203ad0818783d0ecb99836894f2a032527498527a701fd430c323ccb8ece0033340147304402206524f73cb7227479566f3c5caadabfdf8d249a8b22fca73da27bae7e2595db1302203ad0818783d0ecb99836894f2a032527498527a701fd430c323ccb8ece00333401feffffff01502198000000000017a914dc23591e74f7996dab5b29e37d2d63dbe5bae36b8791010500",
                "010000000146d7031756aa92f7236da41adc1b840c1e72ba12d8bec9596d81b1443fda1f4500000000fc0047304402205e353a87a9b934f45b2cdeadc1c45b55f0f9e5c2f1530772a9cd2534437ea1d90220483ea62d543531875abba69e564e62147c7b4e7c02f3c06ab790a47cd44209070147304402205e353a87a9b934f45b2cdeadc1c45b55f0f9e5c2f1530772a9cd2534437ea1d90220483ea62d543531875abba69e564e62147c7b4e7c02f3c06ab790a47cd4420907014c69524c2103f779c124bfb32f6015f4854c7fa8bcbf7369687c58b558040150aa8273b822324c4104f779c124bfb32f6015f4854c7fa8bcbf7369687c58b558040150aa8273b82232244d209162c5afe7116bdd869dea7539579d85e42a6057f05048451ff0ca449352aeffffffff0130d39700000000001976a9147c6d4a7724cb62e7d8766e510550113b3770097888ac00000000",
                "0100000000010100010000000000000000000000000000000000000000000000000000000000000000000000ffffffff01e8030000000000001976a9144c9c3dfac4207d5d8cb89df5722cb3d712385e3f88ac02483045022100cfb07164b36ba64c1b1e8c7720a56ad64d96f6ef332d3d37f9cb3c96477dc44502200a464cd7a9cf94cd70f66ce4f4f0625ef650052c7afcfe29d7d7e01830ff91ed012103596d3451025c19dbbdeb932d6bf8bfb4ad499b95b6f88db8899efac102e5fc7100000000"
            ]

    forM_ ([0..] `zip` blocks) $ \(i, raw) -> do
        assertEqual ("wrong sizeOf result for block " ++ show i)
            (length raw `div` 2)
            (sizeOf (clearEncCache (hex2block raw)))

    forM_ ([0..] `zip` txns) $ \(i, raw) -> do
        assertEqual ("wrong sizeOf result for tx " ++ show i)
            (length raw `div` 2)
            (sizeOf (hex2tx raw))

encTests = TestList [
        TestLabel "basic encoding tests" basicEncTest,
        TestLabel "basic decoding tests" basicDecTest,

        TestLabel "hash256 basic" hash256Test,

        TestLabel "size test" sizeOfTest
    ]
